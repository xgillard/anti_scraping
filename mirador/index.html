<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Mirador Viewer Secure</title>
    <style>#demo { width: 100%; height: 100vh; position: relative; }</style>
</head>
<body>
    <div id="viewer"></div>
    <script src="https://unpkg.com/mirador@latest/dist/mirador.min.js"></script>

    <script>
	// rien a changer pour cette partie, tu continues a faire comme avant
	const urlParams = new URLSearchParams(window.location.search);
        const resourceId = urlParams.get('id');
	

        const parts = resourceId.split('_');
        const rootid= parts[0];
	const collec= `${parts[0]}_${parts[1]}_${parts[2]}`;

	const timestamp = Date.now(); 
	const manifestUrl = `/data/json/${rootid}/${collec}/${resourceId}/${resourceId}.json?nocache=${timestamp}`;

	console.log(manifestUrl);
    </script>

    <script>
      var miradorInstance = Mirador.viewer(
	{
        id: "viewer",
        windows: [
            {
                id: 'AGR_viewer',
		// ======================================================
                // C'est le seul truc qui change: on va utiliser un 
		// manifeste servi par le server afin de configurer 
		// mirador pour qu'il utilise le service d'authentification
		// et de verification du token
		// ======================================================
                manifestId: manifestUrl,
                maximized: false,
                imageToolsEnabled: true,
                imageToolsOpen: false,
                textOverlay: {
                    enabled: true,
                    selectable: true,
                    visible: true
                },
            }
        ],
       
        window: {
            allowClose: false,
            allowFullscreen: true,
            allowMaximize: false,
            allowTopMenuButton: true,
            allowWindowSideBar: true,
            sideBarPanel: 'canvas',
            defaultView: 'single',
            hideWindowTitle: false,
            showLocalePicker: true,
            sideBarOpen: true,
            panels: {
                info: true,
                attribution: true,
                canvas: true,
                annotations: false,
                search: false,
                layers: false,
            },
            views: [
               { key: 'single', behaviors: ['individuals'] }
           ]
        },
       
        thumbnailNavigation: {
            defaultPosition: 'far-bottom',
            displaySettings: true
        },
       
        workspace: {
            allowNewWindows: false,
            isWorkspaceAddVisible: false,
            showZoomControls: true,
            type: 'mosaic'
        },
       
        workspaceControlPanel: {
            enabled: true
        },
 
        osdConfig: {
            alwaysBlend: false,
            blendTime: 0.1,
            preserveImageSizeOnResize: true,
            sequenceMode: true,
            preserveViewport: true,
            showNavigationControl: false,
            showSequenceControl: false,
            maxZoomLevel: 0.1
        }
    });
    </script>
</body>
</html>
